<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Earning Fixed</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src='//libtl.com/sdk.js' data-zone='10318378' data-sdk='show_10318378'></script>
    <script type='text/javascript' src='https://pl28272285.effectivegatecpm.com/79/ca/d6/79cad6252204e9c90dd50644a69e75f9.js'></script>

    <style>
        :root { --bg: #0b1426; --neon: #00f0ff; --glass: rgba(255, 255, 255, 0.08); }
        body { margin: 0; padding: 15px; background: var(--bg); color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        .orb { width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--neon); box-shadow: 0 0 15px var(--neon); display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 20px 0; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 20px; }
        .s-box { background: var(--glass); padding: 10px; border-radius: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
        .btn { padding: 15px; border-radius: 10px; border: 1px solid var(--neon); background: var(--glass); color: #fff; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-disabled { filter: grayscale(1); opacity: 0.6; pointer-events: none !important; cursor: not-allowed; }
        #toast { position: fixed; bottom: 20px; background: #000; padding: 10px 20px; border-radius: 20px; visibility: hidden; }
    </style>
</head>
<body>

    <div class="orb">
        <span style="font-size: 30px; font-weight: bold;" id="ptsDisplay">0</span>
        <small>POINTS</small>
    </div>

    <div class="stats">
        <div class="s-box"><small>Monetag Ads</small><br><strong id="mLabel">0/20</strong></div>
        <div class="s-box"><small>Adstar Today</small><br><strong id="aLabel">0/10</strong></div>
    </div>

    <div class="btn-grid">
        <button class="btn" id="mBtn" onclick="watchM()"><i class="fas fa-play"></i> <span id="mText">MONETAG AD</span></button>
        <button class="btn" id="aBtn" onclick="watchA()"><i class="fas fa-star"></i> <span id="aText">ADSTAR TASK</span></button>
        <button class="btn" onclick="doWithdraw()"><i class="fas fa-wallet"></i> WITHDRAW</button>
        <button class="btn" onclick="doRefer()"><i class="fas fa-users"></i> REFER</button>
    </div>

    <div id="toast">Notification</div>

    <script>
        const BACKEND = "https://monetagads4241r.onrender.com";
        const ADSTAR_LINK = "https://www.effectivegatecpm.com/e0xpfuhe?key=fb81fa455f0ff2d6a8fa09ce5d18dd57";
        const tg = window.Telegram.WebApp;
        
        const firebaseConfig = {
          apiKey: "AIzaSyBHgVkLJu7ROlQYcvx7sxDJjEJymZkXEdR",
          authDomain: "monetas-ads-4241.firebaseapp.com",
          projectId: "monetas-ads-4241",
          storageBucket: "monetas-ads-4241.firebasestorage.app",
          messagingSenderId: "482009819786",
          appId: "1:482009819786:web:8606ae48b666bfd9a1db73"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let uid = String(tg.initDataUnsafe?.user?.id || "test_user");

        db.collection('users').doc(uid).onSnapshot(doc => {
            if(doc.exists) {
                const d = doc.data();
                document.getElementById('ptsDisplay').innerText = d.coins || 0;
                const today = new Date().toISOString().slice(0,10);
                const mC = d.lastAdDate === today ? (d.adsToday || 0) : 0;
                const aC = d.lastAdstarDate === today ? (d.adstarToday || 0) : 0;
                
                document.getElementById('mLabel').innerText = `${mC}/20`;
                document.getElementById('aLabel').innerText = `${aC}/10`;
                
                updateTimers(d.lastAdTime, d.lastAdstarTime, mC, aC);
            }
        });

        function updateTimers(mLast, aLast, mC, aC) {
            const now = Date.now();
            
            // Monetag Logic
            const mb = document.getElementById('mBtn');
            const mt = document.getElementById('mText');
            if(mC >= 20) { mb.classList.add('btn-disabled'); mt.innerText = "LIMIT REACHED"; }
            else {
                const diff = mLast ? (now - mLast.toDate().getTime()) / 1000 : 999;
                if(diff < 300) startTimer(mb, mt, 300 - diff, "MONETAG AD");
                else { mb.classList.remove('btn-disabled'); mt.innerText = "MONETAG AD"; }
            }

            // Adstar Logic
            const ab = document.getElementById('aBtn');
            const at = document.getElementById('aText');
            if(aC >= 10) { ab.classList.add('btn-disabled'); at.innerText = "LIMIT REACHED"; }
            else {
                const diff = aLast ? (now - aLast.toDate().getTime()) / 1000 : 999;
                if(diff < 1200) startTimer(ab, at, 1200 - diff, "ADSTAR TASK");
                else { ab.classList.remove('btn-disabled'); at.innerText = "ADSTAR TASK"; }
            }
        }

        function startTimer(btn, txtObj, sec, original) {
            btn.classList.add('btn-disabled');
            let s = Math.floor(sec);
            const inter = setInterval(() => {
                txtObj.innerText = `WAIT ${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
                if(s-- <= 0) { clearInterval(inter); btn.classList.remove('btn-disabled'); txtObj.innerText = original; }
            }, 1000);
        }

        function watchM() {
            if(typeof show_10318378 === 'function') {
                show_10318378({ymid: uid}).then(() => {
                    fetch(`${BACKEND}/api/claim-reward`, {method:'POST', headers:{'x-telegram-init-data': tg.initData}});
                    showToast("Ad Viewed! 5 min wait.");
                });
            }
        }

        function watchA() {
            window.open(ADSTAR_LINK, '_blank');
            fetch(`${BACKEND}/api/claim-adstar`, {method:'POST', headers:{'x-telegram-init-data': tg.initData}});
            showToast("Task Started! 20 min wait.");
        }

        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.visibility = 'visible'; setTimeout(()=>t.style.visibility='hidden', 3000); }
        function doRefer() { navigator.clipboard.writeText(`https://t.me/realldoler87ok_bot?start=${uid}`); showToast("Refer Link Copied!"); }
        function doWithdraw() { showToast("Min 600 Points & 3 Referrals Required."); }

        fetch(`${BACKEND}/api/sync`, {method:'POST', headers:{'x-telegram-init-data': tg.initData}});
    </script>
</body>
    </html>
