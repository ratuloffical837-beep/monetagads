<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Dragon Earner</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="//libtl.com/sdk.js" data-zone="10318378" data-sdk="show_10318378"></script>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght=500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #03060a;
            --glass: rgba(255, 255, 255, 0.08);
            --neon-blue: #00f0ff;
            --neon-purple: #bc13fe;
            --fire-red: #ff3300;
            --fire-orange: #ff8b00;
            --text-main: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 20px;
            background: radial-gradient(circle at center, #111a2d 0%, var(--bg) 100%);
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }

        /* --- DRAGON STAGE --- */
        .orb-stage {
            position: relative;
            width: 280px; height: 250px;
            margin: 30px 0 50px;
            display: flex; justify-content: center; align-items: center;
            transform: scale(0.9);
        }

        .orb-container {
            position: absolute;
            width: 200px; height: 200px;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            z-index: 2;
        }

        .orb {
            width: 170px; height: 170px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.15), transparent 50%),
                        linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
            box-shadow: 0 0 50px rgba(0, 240, 255, 0.5), inset 0 0 30px rgba(255,255,255,0.3);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative;
            z-index: 3;
            animation: float 4s ease-in-out infinite, pulseGlow 5s infinite alternate;
            transition: transform 0.2s;
            cursor: pointer;
        }

        @keyframes pulseGlow {
            0% { box-shadow: 0 0 40px rgba(0, 240, 255, 0.5), inset 0 0 30px rgba(255,255,255,0.3); }
            100% { box-shadow: 0 0 60px rgba(188, 19, 254, 0.6), inset 0 0 35px rgba(255,255,255,0.4); }
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .points-val { font-family: 'Orbitron', sans-serif; font-size: 48px; font-weight: 900; color: #fff; text-shadow: 0 0 15px var(--neon-blue); }
        .points-label { font-size: 14px; letter-spacing: 3px; opacity: 0.8; text-transform: uppercase; font-weight: 700; }

        /* --- DRAGON ANIMATION --- */
        .dragon {
            position: absolute;
            bottom: 0; right: 0; 
            width: 100px; height: 100px;
            background: url('https://i.imgur.com/rQ0nI7x.png') no-repeat center center / contain; 
            filter: drop-shadow(0 0 5px rgba(255, 51, 0, 0.8));
            transform: rotate(-10deg);
            animation: dragonBreath 2s infinite ease-in-out;
            z-index: 1;
        }

        .fire {
            position: absolute;
            top: 10px; left: 10px;
            width: 50px; height: 50px;
            background: radial-gradient(circle, var(--fire-orange) 0%, var(--fire-red) 50%, transparent 80%);
            border-radius: 50%;
            filter: blur(5px);
            opacity: 0;
            animation: fireEffect 2s infinite ease-out;
            z-index: 0;
        }

        @keyframes dragonBreath {
            0%, 100% { transform: rotate(-10deg); }
            50% { transform: rotate(-15deg); }
        }

        @keyframes fireEffect {
            0% { opacity: 0; transform: scale(0.5) translate(0, 0); }
            30% { opacity: 0.8; transform: scale(1.2) translate(10px, 10px); }
            60% { opacity: 0.5; transform: scale(0.8) translate(20px, 0); }
            100% { opacity: 0; transform: scale(0.5) translate(30px, -10px); }
        }

        /* --- STATS BOX & BUTTONS (Same as before, minimal styling changes) --- */
        .stats-panel {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 15px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; gap: 15px; align-items: center;
        }
        .grid-menu {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 100%; max-width: 400px;
        }

        .btn-3d {
            position: relative;
            background: linear-gradient(to bottom, #2a2a2a, #1a1a1a);
            border: none;
            border-radius: 12px;
            padding: 0;
            cursor: pointer;
            outline-offset: 4px;
            transition: filter 250ms;
        }

        /* Button Colors adjusted for better contrast */
        .btn-primary .btn-face { background: linear-gradient(135deg, #0077ff, #00c6ff); box-shadow: 0 0 15px rgba(0, 119, 255, 0.4); }
        .btn-secondary .btn-face { background: linear-gradient(135deg, #ff00ff, #bc13fe); box-shadow: 0 0 15px rgba(255, 0, 255, 0.4); }
        .btn-danger .btn-face { background: linear-gradient(135deg, #ff4d4d, #c0392b); }
        .btn-refer .btn-face { background: linear-gradient(135deg, #00cc66, #00994d); box-shadow: 0 0 15px rgba(0, 204, 102, 0.4); }
        
        .btn-3d:active .btn-face { transform: translateY(0); }
        .btn-face {
            display: block; position: relative;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px; font-weight: 700; color: white;
            background: #222;
            transform: translateY(-4px);
            transition: transform 150ms;
            border: 1px solid rgba(255,255,255,0.1);
            text-transform: uppercase;
            letter-spacing: 1px;
            overflow: hidden;
            pointer-events: none;
        }
        
        /* Modal styles remain the same for functionality */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: #151922; border: 1px solid var(--neon-blue); padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 0 30px rgba(0,240,255,0.1); position: relative; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--neon-blue); color: #000; padding: 10px 20px; border-radius: 30px; font-weight: bold; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 2000; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    </style>
</head>
<body>

    <div style="width: 100%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="font-weight: bold; font-size: 18px; font-family:'Orbitron', sans-serif;">HELLO, <span id="username" style="color:var(--neon-blue)">USER</span></div>
        <div id="connectionStatus" style="font-size:12px; font-weight:700; color:#555;">‚óè SERVER OFFLINE</div>
    </div>

    <div class="orb-stage">
        <div class="dragon">
            <div class="fire"></div>
        </div>
        <div class="orb-container">
            <div class="orb" id="orbBtn">
                <span class="points-val" id="pointsDisplay">0</span>
                <span class="points-label">POINTS</span>
            </div>
        </div>
    </div>

    <div class="stats-panel">
        <span class="stat-icon" style="color:var(--fire-orange)">üî•</span>
        <div>Ads Watched: <strong id="adsDisplay" style="color: white; font-family:'Orbitron', sans-serif;">0</strong></div>
    </div>

    <div class="grid-menu">
        <button class="btn-3d btn-primary" id="watchAdBtn" onclick="watchAd()">
            <span class="btn-face">WATCH AD</span>
        </button>
        
        <button class="btn-3d btn-secondary" onclick="openModal('withdrawModal')">
            <span class="btn-face">WITHDRAW</span>
        </button>

        <button class="btn-3d btn-refer" onclick="openReferralModal()">
            <span class="btn-face">REFER & EARN</span>
        </button>

        <button class="btn-3d" onclick="loadLeaderboard()">
            <span class="btn-face">TOP USERS</span>
        </button>
        
        <button class="btn-3d btn-danger" style="grid-column: span 2;" onclick="Telegram.WebApp.close()">
            <span class="btn-face">EXIT APP</span>
        </button>
    </div>

    <div class="modal-overlay" id="withdrawModal">
        <div class="modal">
            <h2>CASH OUT</h2>
            <p style="font-size: 12px; color: #aaa;">Requirements: 1000+ Points & 20+ Referrals</p>
            <input type="number" id="wInputPoints" placeholder="Enter Points to Withdraw (Min 1000)">
            <select id="wMethod">
                <option value="Bkash">Bkash</option>
                <option value="Nagad">Nagad</option>
                <option value="Rocket">Rocket</option>
            </select>
            <input type="number" id="wNumber" placeholder="Wallet Number (11 Digits)">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn-3d btn-primary" onclick="submitWithdraw()">
                    <span class="btn-face">SUBMIT</span>
                </button>
                <button class="btn-3d btn-danger" onclick="closeModal('withdrawModal')">
                    <span class="btn-face">CANCEL</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="referralModal">
        <div class="modal">
            <h2>INVITE FRIENDS</h2>
            <p>Earn <span style="color:var(--neon-blue)">2 Points</span> for every friend you invite!</p>
            <div class="copy-box">
                <input type="text" id="refLink" readonly style="width: 100%; padding: 10px; border: 1px solid #333; background: #0e0e0e; color: white; border-radius: 8px;">
                <button class="btn-3d btn-primary" style="width: 80px;" onclick="copyReferralLink()">
                     <span class="btn-face" style="transform: translateY(0); padding: 10px;">COPY</span>
                </button>
            </div>
            <p style="margin-top: 20px;">You have referred:</p>
            <h1 id="refCountDisplay" style="color:var(--neon-purple); margin:0;">0</h1>
            <p style="font-size:12px; opacity:0.7">PEOPLE</p>

            <button class="btn-3d btn-secondary" onclick="closeModal('referralModal')" style="margin-top:15px; width:100%">
                <span class="btn-face">CLOSE</span>
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="leaderboardModal">
        <div class="modal">
            <h2>TOP DRAGONS</h2>
            <div id="leaderboardList" style="text-align:left; max-height: 200px; overflow-y:auto; font-size:14px; margin-top: 15px;">
                </div>
            <button class="btn-3d btn-secondary" onclick="closeModal('leaderboardModal')" style="margin-top:15px; width:100%">
                <span class="btn-face">CLOSE</span>
            </button>
        </div>
    </div>

    <div class="toast" id="toast">Notification</div>

    <script>
        // --- CONFIGURATION ---
        // *** ‡¶®‡¶§‡ßÅ‡¶® URL ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã ***
        const BACKEND_URL = "https://monetagads4241.onrender.com"; 
        const MONETAG_FUNC = "show_10318378"; 
        const BOT_USERNAME = "realldoler87ok_bot"; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Telegram Bot Username
        
        // Firebase Public Config 
        const firebaseConfig = {
            apiKey: "AIzaSyDzqE5shOJtwd-iYYIEhzx_WbxuS6gdiwY",
            authDomain: "telegram-web-app-f8f42.firebaseapp.com",
            projectId: "telegram-web-app-f8f42",
            storageBucket: "telegram-web-app-f8f42.firebasestorage.app",
            messagingSenderId: "832378414446",
            appId: "1:832378414446:web:eb811e28bda89536518d7f"
        };

        // --- INIT ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let state = { coins: 0, ads: 0, referrals: 0, userId: null };
        const coinSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3');

        // --- APP LOGIC (LIFECYCLE) ---

        function initApp() {
            const user = tg.initDataUnsafe?.user;
            const startParam = tg.initDataUnsafe?.start_param || null;

            if(!user) {
                state.userId = "test_user_1";
                document.getElementById('username').innerText = "TESTER";
            } else {
                state.userId = String(user.id);
                document.getElementById('username').innerText = (user.first_name || "User").toUpperCase();
            }

            // 1. Sync User & Referrals
            fetch(`${BACKEND_URL}/api/sync`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-telegram-init-data': tg.initData 
                },
                body: JSON.stringify({ startParam: startParam })
            }).then(res => {
                const statusElement = document.getElementById('connectionStatus');
                if(res.ok) {
                    statusElement.style.color = '#00ff00';
                    statusElement.innerText = '‚óè SERVER ONLINE';
                } else {
                    statusElement.style.color = 'red';
                    statusElement.innerText = '‚óè AUTH FAILED';
                }
            }).catch(e => {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.style.color = 'yellow';
                statusElement.innerText = '‚óè OFFLINE';
            });

            // 2. Realtime Listener
            db.collection('users').doc(state.userId).onSnapshot(doc => {
                const statusElement = document.getElementById('connectionStatus');
                if(doc.exists) {
                    const data = doc.data();
                    
                    if(data.coins > state.coins) {
                        pulseOrb();
                        triggerConfetti();
                        coinSound.play().catch(()=>{});
                    }

                    state.coins = data.coins || 0;
                    state.ads = data.totalAdsWatched || 0;
                    state.referrals = data.referrals || 0;
                    updateUI();
                    
                    // DB Connection successful
                    if (statusElement.innerText !== '‚óè SERVER ONLINE') {
                        statusElement.style.color = '#00ff00';
                        statusElement.innerText = '‚óè DB CONNECTED';
                    }

                } else {
                    // This error is less likely now with correct rules
                    if(statusElement.innerText !== '‚óè SERVER ONLINE') {
                        statusElement.style.color = 'orange';
                        statusElement.innerText = '‚óè DB OFFLINE';
                    }
                }
            }, err => {
                showToast("DB Connection Error: Check Firebase Rules/Status.", '#ff4d4d');
            });
        }

        function updateUI() {
            document.getElementById('pointsDisplay').innerText = state.coins.toLocaleString();
            document.getElementById('adsDisplay').innerText = state.ads.toLocaleString();
            document.getElementById('refCountDisplay').innerText = state.referrals.toLocaleString();
        }

        // --- ADS & REWARD (LOGIC REMAINS SAME AND SECURE) ---
        function watchAd() {
            const btn = document.getElementById('watchAdBtn');
            btn.style.filter = "grayscale(1)";
            
            if (typeof window[MONETAG_FUNC] === 'function') {
                // Production Ad
                window[MONETAG_FUNC]().then(() => {
                    claimReward();
                }).catch(e => {
                    showToast("Ad Closed/Error. Please try again.");
                    btn.style.filter = "none";
                });
            } else {
                // Fallback for testing only
                showToast("Testing Mode: Claiming reward in 2s.");
                setTimeout(() => claimReward(), 2000); 
            }
        }

        async function claimReward() {
            const btn = document.getElementById('watchAdBtn');
            try {
                const res = await fetch(`${BACKEND_URL}/api/claim-reward`, {
                    method: 'POST',
                    headers: { 'x-telegram-init-data': tg.initData }
                });
                
                const data = await res.json(); 

                if(res.ok) {
                    showToast("+1 POINT EARNED!");
                } else {
                    let errorMsg = data.error || "Reward Failed: Unknown Server Error";
                    if (errorMsg.includes('Integrity Failed')) {
                        errorMsg = "Security Check Failed! (Update Bot Token in Render)";
                    } else if (errorMsg.includes('DB Write Error')) {
                        errorMsg = "Database Error! (Check Firebase Service Account)";
                    }
                    showToast(errorMsg, '#ff4d4d'); 
                }
            } catch(e) {
                showToast("Network Error: Cannot connect to server.");
            } finally {
                btn.style.filter = "none";
            }
        }

        // --- REFERRAL & WITHDRAW (LOGIC REMAINS SAME) ---

        function openReferralModal() {
            const link = `https://t.me/${BOT_USERNAME}?start=${state.userId}`;
            document.getElementById('refLink').value = link;
            openModal('referralModal');
        }

        function copyReferralLink() {
            const input = document.getElementById('refLink');
            input.select();
            input.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(input.value).then(() => {
                showToast("Link Copied!");
            }).catch(err => {
                 showToast("Copy failed.");
            });
        }

        async function submitWithdraw() {
            const method = document.getElementById('wMethod').value;
            const number = document.getElementById('wNumber').value.trim();
            const amountPoints = parseInt(document.getElementById('wInputPoints').value);

            if(isNaN(amountPoints) || amountPoints < 1000) return showToast("Minimum withdrawal is 1000 Points.");
            if(amountPoints > state.coins) return showToast("Insufficient Points.");
            if(number.length !== 11) return showToast("Wallet Number must be 11 digits.");
            
            showToast("Submitting Withdrawal...");

            try {
                const res = await fetch(`${BACKEND_URL}/api/withdraw`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-telegram-init-data': tg.initData 
                    },
                    body: JSON.stringify({ method, number, amountPoints })
                });

                const data = await res.json();
                if(res.ok) {
                    showToast("Withdrawal Sent! We will process it soon.");
                    closeModal('withdrawModal');
                } else {
                    showToast(data.error || "Failed to submit withdrawal request.");
                }
            } catch(e) {
                showToast("Connection Error submitting withdrawal.");
            }
        }

        async function loadLeaderboard() {
            openModal('leaderboardModal');
            const list = document.getElementById('leaderboardList');
            list.innerHTML = "<div style='text-align: center; color: #999;'>Loading Leaders...</div>";

            try {
                const snap = await db.collection('users').orderBy('coins', 'desc').limit(10).get();
                let html = "";
                snap.forEach((doc, index) => {
                    const d = doc.data();
                    const name = d.firstName || d.username || 'User'; 
                    const rankColor = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '#ccc';
                    const isCurrentUser = d.userId === state.userId ? 'style="background: #202c40; border-radius: 5px;"' : '';

                    html += `
                        <div class="list-item" ${isCurrentUser} style="display: flex; justify-content: space-between; padding: 5px 0;">
                            <span><strong style="color: ${rankColor}">#${index+1}</strong> ${name}</span>
                            <span style="color:var(--neon-blue); font-family:'Orbitron', sans-serif;">${d.coins.toLocaleString()}</span>
                        </div>`;
                });
                list.innerHTML = html;
                if (snap.empty) {
                    list.innerHTML = "<div style='text-align: center; color: #999;'>No users found.</div>";
                }
            } catch(e) {
                list.innerHTML = "<div style='text-align: center; color: red;'>Error loading data. Check Firebase Rules.</div>";
            }
        }

        // --- UTILS & ANIMATIONS ---
        function pulseOrb() {
            const orb = document.getElementById('orbBtn');
            orb.classList.add('hit');
            setTimeout(() => orb.classList.remove('hit'), 500);
        }

        function triggerConfetti() {
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 },
                colors: ['#00f0ff', '#bc13fe', '#ff3300', '#ffffff']
            });
        }

        function showToast(msg, bgColor = '#00f0ff') {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.background = bgColor;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 4000);
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Boot
        initApp();

    </script>
</body>
    </html>
