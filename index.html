<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earn Pro Max</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src='//libtl.com/sdk.js' data-zone='10318378' data-sdk='show_10318378' async></script>

    <style>
        :root { --neon: #00f0ff; --bg: #0b1426; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; padding: 15px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .social a { color: white; margin-right: 15px; font-size: 22px; cursor: pointer; text-decoration: none; }
        
        .orb { width: 125px; height: 125px; border-radius: 50%; border: 4px solid var(--neon); box-shadow: 0 0 15px var(--neon); margin: 15px auto; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #000; }
        .bal-val { font-size: 26px; font-weight: bold; color: var(--neon); }
        .orb small { font-size: 10px; opacity: 0.7; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .s-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .s-box b { color: var(--neon); font-size: 15px; display: block; }
        .s-box small { font-size: 11px; opacity: 0.8; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 11px; font-weight: bold; gap: 5px; }
        .btn-full { grid-column: span 2; background: linear-gradient(90deg, #00f0ff, #0072ff); color: #000; border: none; font-size: 13px; }
        .btn:disabled { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; }

        #wModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a2236; border: 2px solid var(--neon); padding: 20px; border-radius: 20px; width: 80%; display: none; z-index: 1000; }
        #wModal input, #wModal select { width: 100%; padding: 10px; margin: 8px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 8px; box-sizing: border-box; }
        #toast { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: var(--neon); color: #000; padding: 10px 20px; border-radius: 25px; display: none; font-weight: bold; z-index: 2000; }
    </style>
</head>
<body>

    <div class="header">
        <div class="social">
            <a onclick="window.open('https://www.facebook.com/share/1Lxkm78smE/', '_blank')"><i class="fab fa-facebook"></i></a>
            <a onclick="window.open('https://t.me/ratulhossain56', '_blank')"><i class="fab fa-telegram"></i></a>
            <a onclick="window.open('https://youtube.com/@alex-42-41?si=TZsqZNj0Gey4g5rq', '_blank')"><i class="fab fa-youtube"></i></a>
        </div>
        <div id="uName" style="font-size: 12px;">User</div>
    </div>

    <div class="orb">
        <div class="bal-val" id="balance">0</div>
        <small>POINTS</small>
    </div>

    <div class="stat-grid">
        <div class="s-box"><small>Monetag Ads</small><b id="dMonetag">0/20</b></div>
        <div class="s-box"><small>Total Ad Count</small><b id="tMonetag">0</b></div>
        <div class="s-box" style="grid-column: span 2;"><small>Adsterra Task</small><b id="dAdsterra">0/10</b></div>
    </div>

    <div class="btn-grid">
        <button class="btn" id="mBtn" onclick="runMonetag()"><i class="fas fa-play"></i> MONETAG <span id="mT"></span></button>
        <button class="btn" id="aBtn" onclick="runAdsterra()"><i class="fas fa-tasks"></i> DAILY TASK <span id="aT"></span></button>
        <button class="btn" onclick="copy('refer')"><i class="fas fa-user-plus"></i> REFER (+1 PT)</button>
        <button class="btn" onclick="openCashout()"><i class="fas fa-wallet"></i> CASHOUT</button>
        <button class="btn btn-full" onclick="copy('monetag')"><i class="fas fa-link"></i> MONETAG DIRECT LINK</button>
        <button class="btn btn-full" style="background:#ff4757; color:white;" onclick="copy('adsterra')"><i class="fas fa-link"></i> ADSTERRA DIRECT LINK</button>
    </div>

    <div id="wModal">
        <h4 style="margin:0; text-align:center; color:var(--neon)">Cashout (Min 800)</h4>
        <select id="meth"><option>Bkash</option><option>Nagad</option><option>Rocket</option></select>
        <input type="number" id="amt" placeholder="Points (800+)">
        <input type="text" id="num" placeholder="Account Number">
        <button class="btn btn-full" style="width:100%;" onclick="submitWithdraw()">SUBMIT</button>
        <button onclick="closeCashout()" style="background:none; border:none; color:#ff4757; width:100%; margin-top:10px; font-weight:bold;">Cancel</button>
    </div>

    <div id="toast"></div>

    <script>
        const tg = window.Telegram.WebApp;
        const userId = String(tg.initDataUnsafe?.user?.id || "dev_user");
        const BACKEND = "https://monetagads4241r.onrender.com";

        firebase.initializeApp({
            apiKey: "AIzaSyBHgVkLJu7ROlQYcvx7sxDJjEJymZkXEdE",
            authDomain: "monetas-ads-4241.firebaseapp.com",
            projectId: "monetas-ads-4241",
            storageBucket: "monetas-ads-4241.firebasestorage.app",
            messagingSenderId: "482009819786",
            appId: "1:482009819786:web:8606ae48b666bfd9a1db73"
        });
        const db = firebase.firestore();
        let uData = { balance: 0, dailyMonetag: 0, totalMonetag: 0, dailyAdsterra: 0, lastMonetagTime: 0, lastAdsterraTime: 0 };

        // Listen to Database - Zero Undefined Logic
        db.collection('users').doc(userId).onSnapshot(doc => {
            if(doc.exists) {
                uData = doc.data();
                document.getElementById('balance').innerText = uData.balance || 0;
                document.getElementById('dMonetag').innerText = `${uData.dailyMonetag || 0}/20`;
                document.getElementById('tMonetag').innerText = uData.totalMonetag || 0;
                document.getElementById('dAdsterra').innerText = `${uData.dailyAdsterra || 0}/10`;
                updateTimerDisplay();
            }
        }, err => console.log("Firestore Error:", err));

        function updateTimerDisplay() {
            const now = Date.now();
            // Monetag 5 Min (300s)
            const mDiff = 300 - Math.floor((now - (uData.lastMonetagTime || 0)) / 1000);
            const mBtn = document.getElementById('mBtn');
            if(mDiff > 0 && uData.dailyMonetag < 20) {
                mBtn.disabled = true;
                document.getElementById('mT').innerText = `(${mDiff}s)`;
            } else {
                mBtn.disabled = (uData.dailyMonetag >= 20);
                document.getElementById('mT').innerText = uData.dailyMonetag >= 20 ? "(Full)" : "";
            }

            // Adsterra 20 Min (1200s)
            const aDiff = 1200 - Math.floor((now - (uData.lastAdsterraTime || 0)) / 1000);
            const aBtn = document.getElementById('aBtn');
            if(aDiff > 0 && uData.dailyAdsterra < 10) {
                aBtn.disabled = true;
                document.getElementById('aT').innerText = `(${Math.ceil(aDiff/60)}m)`;
            } else {
                aBtn.disabled = (uData.dailyAdsterra >= 10);
                document.getElementById('aT').innerText = uData.dailyAdsterra >= 10 ? "(Full)" : "";
            }
        }
        setInterval(updateTimerDisplay, 1000);

        function runMonetag() {
            if(window.show_10318378) {
                show_10318378({ ymid: userId }).then(() => {
                    db.collection('users').doc(userId).update({
                        balance: firebase.firestore.FieldValue.increment(1),
                        dailyMonetag: firebase.firestore.FieldValue.increment(1),
                        totalMonetag: firebase.firestore.FieldValue.increment(1),
                        lastMonetagTime: Date.now()
                    }).then(() => toast("Monetag Reward +1 PT"));
                }).catch(e => toast("Ad Not Loaded"));
            }
        }

        function runAdsterra() {
            window.open("https://www.effectivegatecpm.com/e0xpfuhe?key=fb81fa455f0ff2d6a8fa09ce5d18dd57", "_blank");
            db.collection('users').doc(userId).update({
                balance: firebase.firestore.FieldValue.increment(1),
                dailyAdsterra: firebase.firestore.FieldValue.increment(1),
                lastAdsterraTime: Date.now()
            }).then(() => toast("Adsterra Reward +1 PT"));
        }

        function copy(t) {
            let l = (t==='refer') ? `https://t.me/realldoler87ok_bot?start=${userId}` : (t==='monetag' ? "https://otieu.com/4/10315373" : "https://www.effectivegatecpm.com/e0xpfuhe?key=fb81fa455f0ff2d6a8fa09ce5d18dd57");
            navigator.clipboard.writeText(l); toast("Link Copied!");
        }

        function openCashout() { document.getElementById('wModal').style.display='block'; }
        function closeCashout() { document.getElementById('wModal').style.display='none'; }

        async function submitWithdraw() {
            const amount = document.getElementById('amt').value;
            const number = document.getElementById('num').value;
            const method = document.getElementById('meth').value;
            if(amount < 800) return toast("Min 800 Points!");
            if(!number) return toast("Enter Number!");

            const res = await fetch(`${BACKEND}/api/withdraw`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId, amount, number, method })
            });
            if(res.ok) { toast("Withdraw Success!"); closeCashout(); } else { toast("Low Balance or Error!"); }
        }

        function toast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display='block'; setTimeout(()=>t.style.display='none', 3000); }
        
        document.getElementById('uName').innerText = tg.initDataUnsafe?.user?.first_name || "User";
        fetch(`${BACKEND}/api/sync`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId, name: tg.initDataUnsafe?.user?.first_name, startParam: tg.initDataUnsafe?.start_param }) });
    </script>
</body>
    </html>
