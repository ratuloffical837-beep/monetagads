<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monetag Ads Earner</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src='//libtl.com/sdk.js' data-zone='10318378' data-sdk='show_10318378'></script>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght<500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        :root {
            --bg: #0b0f19;
            --glass: rgba(255, 255, 255, 0.05);
            --neon-blue: #00f0ff;
            --neon-purple: #bc13fe;
            --neon-orange: #ff8b00;
            --text-main: #ffffff;
            --input-bg: #1a1a1a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 20px;
            background: radial-gradient(circle at center, #1a1f2e 0%, var(--bg) 100%);
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
        }

        /* --- 3D ORB --- */
        .orb-stage {
            position: relative;
            width: 220px; height: 220px;
            margin: 30px 0;
            display: flex; justify-content: center; align-items: center;
        }

        .orb {
            width: 180px; height: 180px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), transparent 50%),
                        linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
            box-shadow: 0 0 40px rgba(0, 240, 255, 0.3), inset 0 0 20px rgba(255,255,255,0.2);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative;
            z-index: 2;
            animation: float 4s ease-in-out infinite;
        }

        .orb.pulse { animation: pulseHit 0.3s ease-out; }

        .orb-ring {
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 2px dashed rgba(255,255,255,0.2);
            animation: spin 10s linear infinite;
            pointer-events: none;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulseHit { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.1); filter: brightness(1.5); } 100% { transform: scale(1); filter: brightness(1); } }

        .points-val { font-family: 'Orbitron', sans-serif; font-size: 42px; font-weight: 900; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .points-label { font-size: 14px; letter-spacing: 2px; opacity: 0.8; text-transform: uppercase; }

        /* --- STATS BOX --- */
        .stats-panel {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 15px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            display: flex; gap: 15px; align-items: center; width: 100%; max-width: 400px; justify-content: space-around;
        }

        /* --- 3D BUTTONS --- */
        .grid-menu {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 100%; max-width: 400px;
        }

        .btn-3d {
            position: relative;
            background: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
            outline-offset: 4px;
        }

        .btn-edge {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 12px;
            background: linear-gradient(to left, #0e0e0e 0%, #333 8%, #333 92%, #0e0e0e 100%);
        }

        .btn-face {
            display: block; position: relative;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px; font-weight: 700; color: white;
            transform: translateY(-4px);
            transition: transform 150ms;
            border: 1px solid rgba(255,255,255,0.1);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary .btn-face { background: linear-gradient(135deg, var(--neon-blue), #2a5ee8); box-shadow: 0 0 15px rgba(0,240,255,0.3); }
        .btn-secondary .btn-face { background: linear-gradient(135deg, var(--neon-purple), #8a2be2); box-shadow: 0 0 15px rgba(188,19,254,0.3); }
        .btn-danger .btn-face { background: linear-gradient(135deg, #ff4d4d, #c0392b); }
        .btn-refer .btn-face { background: linear-gradient(135deg, #ff00ff, #bc13fe); box-shadow: 0 0 15px rgba(188,19,254,0.3); }

        .btn-3d:active .btn-face { transform: translateY(0); }

        /* Disable state for cooldown/limit */
        .btn-disabled .btn-face { 
            background: #333 !important; 
            box-shadow: none !important;
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* --- SOCIAL BUTTONS --- */
        .social-buttons {
            display: flex; gap: 10px;
        }
        .social-btn {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            width: 35px; height: 35px;
            display: flex; justify-content: center; align-items: center;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-main);
            transition: background 0.2s;
        }
        .social-btn:hover { background: rgba(255, 255, 255, 0.1); }
        .social-btn i { color: var(--neon-blue); }
        .social-btn.fb i { color: #1877f2; }
        .social-btn.yt i { color: #ff0000; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal {
            background: #151922;
            border: 1px solid var(--neon-blue);
            padding: 25px;
            border-radius: 20px;
            width: 90%; max-width: 350px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,240,255,0.1);
            position: relative;
        }
        .modal h2 { margin-top: 0; color: var(--neon-blue); font-family: 'Orbitron'; margin-bottom: 20px; }
        
        /* FIX FOR INPUT VISIBILITY */
        input, select {
            width: 100%; padding: 12px; margin: 10px 0;
            background: var(--input-bg); /* Dark grey background */
            border: 1px solid #444;
            color: white; /* White text */
            border-radius: 8px; font-family: 'Rajdhani'; font-size: 16px;
            outline: none;
        }
        input:focus, select:focus { border-color: var(--neon-blue); }
        
        /* FIX: Placeholder color for readability */
        ::placeholder { color: #888; opacity: 1; }

        .copy-box { display: flex; gap: 5px; margin-top: 10px; }
        .copy-box input { margin: 0; }
        .btn-copy { background: var(--neon-purple); border: none; color: white; border-radius: 8px; padding: 0 15px; cursor: pointer; font-weight: bold; }

        /* --- TOAST --- */
        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: var(--neon-blue); color: #000;
            padding: 10px 20px; border-radius: 30px;
            font-weight: bold; opacity: 0; transition: all 0.3s;
            pointer-events: none; z-index: 2000;
            text-align: center; width: 80%;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.error { background: #ff4d4d; color: white; }

    </style>
</head>
<body>

    <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
        
        <div class="social-buttons">
            <a href="https://www.facebook.com/share/1D7RcWgUAW/" target="_blank" class="social-btn fb">
                <i class="fab fa-facebook-f"></i>
            </a>
            <a href="https://youtube.com/@alex-42-41?si=fHj-XX2czgI_44Jf" target="_blank" class="social-btn yt">
                <i class="fab fa-youtube"></i>
            </a>
        </div>

        <div style="font-weight: bold;">HELLO, <span id="username" style="color:var(--neon-blue)">USER</span></div>
        <div id="connectionStatus" style="font-size:10px; color:#555;">‚óè</div>
    </div>

    <div class="orb-stage">
        <div class="orb-ring"></div>
        <div class="orb" id="orbBtn">
            <span class="points-val" id="pointsDisplay">0</span>
            <span class="points-label">POINTS</span>
        </div>
    </div>

    <div class="stats-panel">
        <div>Ads Today: <strong id="adsTodayDisplay" style="color:white;">0/60</strong></div>
        <div>Refs: <strong id="refsDisplay" style="color:white;">0</strong></div>
    </div>

    <div class="grid-menu">
        <button class="btn-3d btn-primary" id="watchAdBtn" onclick="watchAd()">
            <span class="btn-edge"></span><span class="btn-face" id="watchAdFace">WATCH AD</span>
        </button>
        
        <button class="btn-3d btn-secondary" onclick="openModal('withdrawModal')">
            <span class="btn-edge"></span><span class="btn-face">WITHDRAW</span>
        </button>

        <button class="btn-3d btn-refer" onclick="openReferralModal()">
            <span class="btn-edge"></span><span class="btn-face">REFER & EARN</span>
        </button>

        <button class="btn-3d btn-danger" onclick="Telegram.WebApp.close()">
            <span class="btn-edge"></span><span class="btn-face">EXIT APP</span>
        </button>
    </div>

    <div class="modal-overlay" id="withdrawModal">
        <div class="modal">
            <h2>CASH OUT</h2>
            <p style="font-size: 12px; color: #ccc; margin-bottom: 10px;">
                Required: 600+ Points & 10+ Referrals
            </p>
            
            <input type="number" id="wInputPoints" placeholder="Enter Points (e.g., 600)">
            
            <select id="wMethod">
                <option value="Bkash">Bkash</option>
                <option value="Nagad">Nagad</option>
                <option value="Rocket">Rocket</option>
            </select>
            
            <input type="number" id="wNumber" placeholder="Wallet Number (01xxx...)">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn-3d btn-primary" onclick="submitWithdraw()">
                    <span class="btn-edge"></span><span class="btn-face">SUBMIT</span>
                </button>
                <button class="btn-3d btn-danger" onclick="closeModal('withdrawModal')">
                    <span class="btn-edge"></span><span class="btn-face">CANCEL</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="referralModal">
        <div class="modal">
            <h2>INVITE FRIENDS</h2>
            <p>Earn <span style="color:var(--neon-blue)">1 Point</span> for every friend!</p>
            
            <div class="copy-box">
                <input type="text" id="refLink" readonly value="Loading...">
                <button class="btn-copy" onclick="copyReferralLink()">COPY</button>
            </div>
            
            <p style="margin-top: 20px;">Total Referred:</p>
            <h1 id="refCountDisplay" style="color:var(--neon-purple); margin:0;">0</h1>

            <button class="btn-3d btn-secondary" onclick="closeModal('referralModal')" style="margin-top:15px; width:100%">
                <span class="btn-edge"></span><span class="btn-face">CLOSE</span>
            </button>
        </div>
    </div>

    <div class="toast" id="toast">Notification</div>

    <script>
        // --- CONFIGURATION ---
        // **UPDATED** to your new Render URL:
        const BACKEND_URL = "https://monetagads4241r.onrender.com"; 
        const TELEGRAM_BOT_USERNAME = "realldoler87ok_bot"; // Bot Username
        
        // Monetag Function Name
        const MONETAG_FUNC = "show_10318378"; 
        
        // Firebase Config (Public) - Project ID: monetas-ads-4241
        const firebaseConfig = {
          apiKey: "AIzaSyBHgVkLJu7ROlQYcvx7sxDJjEJymZkXEdE",
          authDomain: "monetas-ads-4241.firebaseapp.com",
          projectId: "monetas-ads-4241",
          storageBucket: "monetas-ads-4241.firebasestorage.app",
          messagingSenderId: "482009819786",
          appId: "1:482009819786:web:8606ae48b666bfd9a1db73"
        };
        
        // **NEW LIMITS & COOLDOWN**
        const AD_DAILY_LIMIT = 60; // Max ads per day
        const AD_COOLDOWN_SECONDS = 80; // 80 seconds gap between ads

        // --- INIT ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let state = { coins: 0, ads: 0, referrals: 0, userId: null, username: '' };
        let lastAdTime = 0;
        let adsToday = 0;
        let cooldownInterval = null;
        
        // Helper to get today's date string (YYYY-MM-DD)
        function getTodayDateString() {
            return new Date().toISOString().slice(0, 10);
        }

        function initApp() {
            const user = tg.initDataUnsafe?.user;
            const startParam = tg.initDataUnsafe?.start_param || null;

            if(!user) {
                console.warn("No Telegram User detected (Local Mode)");
                state.userId = "test_user_1";
                state.username = "TESTER";
                document.getElementById('username').innerText = "TESTER";
            } else {
                state.userId = String(user.id);
                state.username = user.username || "User";
                document.getElementById('username').innerText = (user.first_name || "User").toUpperCase();
            }

            // 1. Sync User & Handle Referrals
            fetch(`${BACKEND_URL}/api/sync`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-telegram-init-data': tg.initData 
                },
                body: JSON.stringify({ startParam: startParam })
            })
            .then(res => {
                if(res.status === 403) {
                    showToast("Security Check Failed! (Update Bot Token in Render)", true);
                }
            })
            .catch(e => {
                console.error("Sync fail", e);
                document.getElementById('connectionStatus').style.color = 'red';
            });
            
            // 2. Realtime Listener & Daily Ad Count
            db.collection('users').doc(state.userId).onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    
                    if(data.coins > state.coins) {
                        pulseOrb();
                        triggerConfetti();
                    }

                    state.coins = data.coins || 0;
                    state.ads = data.totalAdsWatched || 0;
                    state.referrals = data.referrals || 0;
                    
                    // Daily Ad Counter Logic
                    const today = getTodayDateString();
                    if(data.lastAdDate === today) {
                        adsToday = data.adsToday || 0;
                    } else {
                        // Reset count if it's a new day
                        adsToday = 0;
                        db.collection('users').doc(state.userId).update({
                            adsToday: 0,
                            lastAdDate: today
                        }).catch(e => console.error("Daily Reset Error:", e));
                    }
                    
                    // Restore last ad time for cooldown check
                    if(data.lastAdTime) {
                        lastAdTime = data.lastAdTime.toDate().getTime();
                    }


                    updateUI();
                } else {
                    updateUI();
                }
            });
        }

        function updateUI() {
            document.getElementById('pointsDisplay').innerText = state.coins;
            document.getElementById('refsDisplay').innerText = state.referrals;
            document.getElementById('refCountDisplay').innerText = state.referrals;
            document.getElementById('adsTodayDisplay').innerText = `${adsToday}/${AD_DAILY_LIMIT}`;
            document.getElementById('connectionStatus').style.color = '#00ff00';
            
            checkAdStatus();
        }
        
        function checkAdStatus() {
            const btn = document.getElementById('watchAdBtn');
            const btnFace = document.getElementById('watchAdFace');
            const now = Date.now();
            const timeElapsed = (now - lastAdTime) / 1000;
            const remainingTime = AD_COOLDOWN_SECONDS - timeElapsed;

            if (adsToday >= AD_DAILY_LIMIT) {
                btn.classList.add('btn-disabled');
                btn.onclick = () => showToast("Daily Ad Limit Reached! Try again tomorrow.", true);
                btnFace.innerText = "LIMIT REACHED";
                if(cooldownInterval) clearInterval(cooldownInterval);
                return;
            }

            if (remainingTime > 0) {
                btn.classList.add('btn-disabled');
                btn.onclick = () => showToast(`Wait ${Math.ceil(remainingTime)}s for next ad`, true);
                
                // Start or update cooldown timer display
                if (!cooldownInterval) {
                    cooldownInterval = setInterval(() => {
                        const newRemaining = AD_COOLDOWN_SECONDS - ( (Date.now() - lastAdTime) / 1000 );
                        if (newRemaining <= 0) {
                            clearInterval(cooldownInterval);
                            cooldownInterval = null;
                            checkAdStatus(); // Re-enable button
                        } else {
                            btnFace.innerText = `WAIT ${Math.ceil(newRemaining)}S`;
                        }
                    }, 1000);
                }
            } else {
                // Button Ready
                if(cooldownInterval) clearInterval(cooldownInterval);
                cooldownInterval = null;
                btn.classList.remove('btn-disabled');
                btn.onclick = watchAd;
                btnFace.innerText = "WATCH AD";
            }
        }


        // --- ADS ---
        function watchAd() {
            // Re-check status before showing ad
            const now = Date.now();
            const timeElapsed = (now - lastAdTime) / 1000;
            
            if (adsToday >= AD_DAILY_LIMIT) return showToast("Daily Ad Limit Reached!", true);
            if (timeElapsed < AD_COOLDOWN_SECONDS) return showToast(`Wait ${Math.ceil(AD_COOLDOWN_SECONDS - timeElapsed)}s for next ad`, true);


            const btn = document.getElementById('watchAdBtn');
            btn.classList.add('btn-disabled'); // Temporarily disable button
            
            if (typeof window[MONETAG_FUNC] === 'function') {
                window[MONETAG_FUNC]().then(() => {
                    // Update frontend state immediately
                    lastAdTime = Date.now();
                    adsToday++;
                    
                    // Claim reward on the backend
                    claimReward();
                    
                    // Update UI (starts cooldown timer)
                    checkAdStatus();
                    
                }).catch(e => {
                    showToast("Ad Closed or Not Loaded", true);
                    // Re-enable button if ad failed (but keep cooldown)
                    checkAdStatus(); 
                });
            } else {
                console.log("Monetag SDK missing - Is adblock on? Function:", MONETAG_FUNC);
                showToast("Ad SDK Loading...", true);
                // Simulate Ad completion for testing/if SDK fails to load completely
                
                // --- REMOVE THIS BLOCK IN PRODUCTION IF MONETAG SDK IS RELIABLE ---
                // lastAdTime = Date.now();
                // adsToday++;
                // claimReward();
                // checkAdStatus();
                // ------------------------------------------------------------------
            }
        }

        async function claimReward() {
            try {
                // Also update lastAdDate and adsToday count on the backend
                const res = await fetch(`${BACKEND_URL}/api/claim-reward`, {
                    method: 'POST',
                    headers: { 'x-telegram-init-data': tg.initData }
                });
                
                if(res.ok) {
                    showToast("+1 POINT EARNED!");
                    // Database listener will update full state.
                } else {
                    const data = await res.json();
                    showToast(data.error || "Reward Failed", true);
                }
            } catch(e) {
                showToast("Network Error", true);
            }
        }

        // --- REFERRALS ---
        function openReferralModal() {
            // Uses the Bot Username: realldoler87ok_bot
            const link = `https://t.me/${TELEGRAM_BOT_USERNAME}?start=${state.userId}`;
            document.getElementById('refLink').value = link;
            openModal('referralModal');
        }

        function copyReferralLink() {
            const input = document.getElementById('refLink');
            input.select();
            input.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(input.value).then(() => {
                showToast("Link Copied!");
            });
        }

        // --- WITHDRAW ---
        async function submitWithdraw() {
            const method = document.getElementById('wMethod').value;
            const number = document.getElementById('wNumber').value;
            const amountPoints = parseInt(document.getElementById('wInputPoints').value);

            if(!amountPoints || amountPoints <= 0) return showToast("Enter valid points", true);
            if(!number) return showToast("Enter wallet number", true);

            // Pre-validation (Frontend) - NEW CONDITIONS: 600 points, 10 referrals
            if(state.coins < 600) return showToast("Need 600+ Points", true);
            if(state.referrals < 10) return showToast("Need 10+ Referrals", true);
            if(amountPoints > state.coins) return showToast("Insufficient Balance", true);

            try {
                const res = await fetch(`${BACKEND_URL}/api/withdraw`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-telegram-init-data': tg.initData 
                    },
                    body: JSON.stringify({ method, number, amountPoints })
                });

                const data = await res.json();
                if(res.ok) {
                    showToast("Withdrawal Sent!");
                    closeModal('withdrawModal');
                } else {
                    showToast(data.error || "Failed", true);
                }
            } catch(e) {
                showToast("Network Error", true);
            }
        }

        // --- UTILS ---
        function pulseOrb() {
            const orb = document.getElementById('orbBtn');
            orb.classList.remove('pulse');
            void orb.offsetWidth;
            orb.classList.add('pulse');
        }

        function triggerConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#00f0ff', '#bc13fe', '#ffffff']
            });
        }

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            if(isError) t.classList.add('error');
            else t.classList.remove('error');
            
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Boot
        initApp();

    </script>
</body>
    </html>
