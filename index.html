<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Pro V2</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='10318378' data-sdk='show_10318378'></script>
    <style>
        :root { --bg: #050a14; --neon: #00f0ff; --glass: rgba(255,255,255,0.06); }
        body { margin: 0; padding: 15px; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 45px; height: 45px; border: 4px solid var(--glass); border-top: 4px solid var(--neon); border-radius: 50%; animation: spin 1s linear infinite; }
        .orb { width: 150px; height: 150px; border-radius: 50%; border: 2px solid var(--neon); display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 20px auto; box-shadow: 0 0 15px var(--neon); }
        #pDisp { font-size: 40px; font-weight: 900; color: var(--neon); }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .s-box { background: var(--glass); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 15px 5px; border-radius: 12px; border: 1px solid var(--neon); background: var(--glass); color: #fff; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #000; padding: 10px 20px; border-radius: 20px; border: 1px solid var(--neon); visibility: hidden; z-index: 10000; font-size: 12px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div><p style="color:var(--neon); margin-top:15px;">INITIALIZING...</p></div>
    <div id="app">
        <div style="display:flex; justify-content: space-between; font-size: 12px;"><span style="color: var(--neon);">PRO SYSTEM</span><span id="uNameDisp">USER</span></div>
        <div class="orb"><span id="pDisp">0</span><small>COINS</small></div>
        <div class="stats">
            <div class="s-box"><small>MONETAG</small><br><strong id="mCount">0/20</strong></div>
            <div class="s-box"><small>ADSTAR</small><br><strong id="aCount">0/10</strong></div>
        </div>
        <div class="btn-grid">
            <button class="btn btn-disabled" id="mBtn" onclick="watchM()"><span id="mText">...</span></button>
            <button class="btn btn-disabled" id="aBtn" onclick="watchA()"><span id="aText">...</span></button>
            <button class="btn" onclick="doWithdraw()">WITHDRAW</button>
            <button class="btn" onclick="doRefer()">INVITE</button>
        </div>
    </div>
    <div id="toast">Notice</div>
    <script>
        const BACKEND = "https://monetagads4241r.onrender.com";
        const ADSTAR_URL = "https://www.effectivegatecpm.com/e0xpfuhe?key=fb81fa455f0ff2d6a8fa09ce5d18dd57";
        const tg = window.Telegram.WebApp;
        tg.expand();

        const firebaseConfig = {
          apiKey: "AIzaSyBHgVkLJu7ROlQYcvx7sxDJjEJymZkXEdR",
          authDomain: "monetas-ads-4241.firebaseapp.com",
          projectId: "monetas-ads-4241",
          storageBucket: "monetas-ads-4241.firebasestorage.app",
          messagingSenderId: "482009819786",
          appId: "1:482009819786:web:8606ae48b666bfd9a1db73"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const uid = String(tg.initDataUnsafe?.user?.id || "test_user");

        async function init() {
            try {
                const res = await fetch(`${BACKEND}/api/sync`, {
                    method: 'POST',
                    headers: {'x-telegram-init-data': tg.initData, 'x-start-param': tg.initDataUnsafe.start_param || ''}
                });
                if(res.ok) { document.getElementById('loader').style.display = 'none'; startApp(); }
            } catch(e) { setTimeout(init, 3000); }
        }

        function startApp() {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    document.getElementById('pDisp').innerText = d.coins || 0;
                    document.getElementById('uNameDisp').innerText = (d.uName || "User").toUpperCase();
                    const today = new Date().toISOString().slice(0, 10);
                    const mToday = d.lastAdDate === today ? (d.adsToday || 0) : 0;
                    const aToday = d.lastAdstarDate === today ? (d.adstarToday || 0) : 0;
                    document.getElementById('mCount').innerText = `${mToday}/20`;
                    document.getElementById('aCount').innerText = `${aToday}/10`;
                    
                    // Interval update to handle timers
                    if(window.timerInt) clearInterval(window.timerInt);
                    window.timerInt = setInterval(() => {
                        updateBtn('mBtn', 'mText', d.lastAdTime, mToday, 20, 300, "MONETAG");
                        updateBtn('aBtn', 'aText', d.lastAdstarTime, aToday, 10, 600, "ADSTAR");
                    }, 1000);
                }
            });
        }

        function updateBtn(bid, tid, last, count, limit, cd, label) {
            const btn = document.getElementById(bid), txt = document.getElementById(tid);
            if(count >= limit) { btn.classList.add('btn-disabled'); txt.innerText = "LIMIT"; return; }
            
            // Fixed NaN:NaN check
            const lastMs = (last && last.seconds) ? last.seconds * 1000 : (last ? new Date(last).getTime() : 0);
            const diff = (Date.now() - lastMs) / 1000;

            if(diff < cd) {
                btn.classList.add('btn-disabled');
                let rem = Math.ceil(cd - diff);
                txt.innerText = `${Math.floor(rem/60)}:${(rem%60).toString().padStart(2,'0')}`;
            } else {
                btn.classList.remove('btn-disabled');
                txt.innerText = label;
            }
        }

        function watchM() {
            if(typeof show_10318378 === 'function') {
                show_10318378({ymid: uid}).then(() => {
                    showToast("Verifying...");
                    setTimeout(() => claim('claim-reward'), 2000);
                });
            }
        }

        function watchA() {
            window.open(ADSTAR_URL, '_blank');
            showToast("Stay 15s...");
            setTimeout(() => claim('claim-adstar'), 15000);
        }

        async function claim(ep) {
            const res = await fetch(`${BACKEND}/api/${ep}`, {
                method: 'POST',
                headers: {'x-telegram-init-data': tg.initData}
            });
            const d = await res.json();
            showToast(d.message);
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.visibility = 'visible';
            setTimeout(() => t.style.visibility = 'hidden', 3000);
        }

        function doRefer() {
            const link = `https://t.me/realldoler87ok_bot?start=${uid}`;
            navigator.clipboard.writeText(link).then(() => showToast("Link Copied!"));
        }

        function doWithdraw() {
            fetch(`${BACKEND}/api/withdraw`, {
                method: 'POST',
                headers: {'x-telegram-init-data': tg.initData}
            }).then(r => r.json()).then(d => showToast(d.message));
        }

        window.onload = init;
    </script>
</body>
    </html>
